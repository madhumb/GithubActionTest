name: ðŸš€ iOS Flavored Upload

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose build mode: all flavors or single flavor"
        required: true
        default: "single"
        type: choice
        options:
          - all
          - single
      flavor:
        description: "If single mode, specify flavor (e.g. star)"
        required: false
        default: "star"
      lane:
        description: "Choose Fastlane lane (beta for TestFlight / release for App Store)"
        required: true
        default: "beta"

jobs:
  ##############################################################
  # ðŸ§© Option 1: Build ALL flavors (parallel matrix)
  ##############################################################
  all-flavors:
    if: ${{ github.event.inputs.mode == 'all' }}
    name: Build & Upload (All Flavors)
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        flavor: [
          "star",
          "moon"
        ]

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      # âš¡ Cache Ruby gems (Fastlane + deps)
      - name: ðŸ’Ž Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: ${{ runner.os }}-gems-

      # âš¡ Cache Flutter dependencies
      - name: ðŸ¦‹ Cache Flutter deps
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-

      - name: ðŸ§° Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: ðŸ“¦ Flutter pub get
        run: flutter pub get

      - name: ðŸ’Ž Setup Ruby & Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.4
          bundler-cache: false

      - name: Install Fastlane
        run: gem install fastlane

    #   - name: Set up Ruby and install gems
    #     working-directory: ios/fastlane
    #     run: |
    #         gem install bundler:2.5.11
    #         bundle config set path 'vendor/bundle'
    #         bundle install --jobs 4 --retry 3
        

      - name: ðŸ”‘ Decode API key file
        run: |
          mkdir -p ios/fastlane
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" > ios/fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8
        shell: bash

      - name: ðŸš€ Run Fastlane lane for ${{ matrix.flavor }}
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_PATH: ios/fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APPSTORE_CONNECT_ISSUER_ID }}
        run: |
          bundle exec fastlane ${{ github.event.inputs.lane }}_${{ matrix.flavor }}

      - name: ðŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.flavor }}-ipa
          path: ios/build/ios/${{ matrix.flavor }}.ipa

  ##############################################################
  # ðŸ§© Option 2: Build a SINGLE selected flavor
  ##############################################################
  single-flavor:
    if: ${{ github.event.inputs.mode == 'single' }}
    name: Build & Upload (${{ github.event.inputs.flavor }})
    runs-on: macos-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      # âš¡ Cache Ruby gems (Fastlane + deps)
      - name: ðŸ’Ž Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: ${{ runner.os }}-gems-

      # âš¡ Cache Flutter dependencies
      - name: ðŸ¦‹ Cache Flutter deps
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-

      - name: ðŸ§° Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: ðŸ“¦ Flutter pub get
        run: flutter pub get

      - name: ðŸ’Ž Setup Ruby & Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.4
          bundler-cache: false

      - name: ðŸ“¦ Install gems via Bundler
        run: |
          gem install bundler:2.5.11
          bundle config set path 'vendor/bundle'
          bundle install --jobs 4 --retry 3

      - name: ðŸ”‘ Decode API key file
        run: |
          mkdir -p ios/fastlane
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" > ios/fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8
        shell: bash

      - name: ðŸš€ Run Fastlane for selected flavor
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_PATH: ios/fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APPSTORE_CONNECT_ISSUER_ID }}
        run: |
          bundle exec fastlane ${{ github.event.inputs.lane }}_${{ github.event.inputs.flavor }}

      - name: ðŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.flavor }}-ipa
          path: ios/build/ios/${{ github.event.inputs.flavor }}.ipa
