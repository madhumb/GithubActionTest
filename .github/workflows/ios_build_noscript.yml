name: üöÄ iOS Flavored Upload

on:
  # push:
  #   branches: [ main ]

  workflow_dispatch:
    inputs:
      mode:
        description: "Choose build mode: all flavors or single flavor"
        required: true
        default: "single"
        type: choice
        options:
          - all
          - single
      flavor:
        description: "If single mode, specify flavor (e.g. star)"
        required: false
        default: "star"
      lane:
        description: "Choose Fastlane lane (beta for TestFlight / release for App Store)"
        required: true
        default: "beta"

jobs:
 build:
  name: Build & Upload
  runs-on: macos-latest

  strategy:
    fail-fast: false
    matrix:
      flavor: ${{ fromJson(
        github.event_name == 'push' && '["star","moon"]' ||
        github.event.inputs.mode == 'all' && '["star","moon"]' ||
        format('["{0}"]', github.event.inputs.flavor || 'star')) }}

  steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # üíé Setup Ruby
      - name: ü™Ñ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.4
          bundler-cache: true
          working-directory: ios

      # üíô Setup Flutter
      - name: üíô Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: üì¶ Get Flutter dependencies
        run: flutter pub get

      # üîê Setup Keychain
      - name: üîê Setup Keychain
        run: |
          security create-keychain -p "ci_keychain_pass" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "ci_keychain_pass" build.keychain
          security list-keychains -s build.keychain

      # üîë Create App Store API key file
      - name: üîë Create API key file
        run: |
          mkdir -p ios/fastlane
          echo "Creating API key file for $APPSTORE_CONNECT_API_KEY_ID"
          printf "%s" "$APP_STORE_CONNECT_API_KEY" > ios/fastlane/AuthKey_${APPSTORE_CONNECT_API_KEY_ID}.p8
          ls -l ios/fastlane/
        env:
          APPSTORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}

      - name: üì¶ Install iOS Pods
        run: |
          cd ios
          rm -rf Pods Podfile.lock
          flutter clean
          flutter pub get
          pod repo update
          pod install

      # üèóÔ∏è Build & Upload flavor
      - name: üèóÔ∏è Build & Upload (${{ matrix.flavor }})
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: https://github.com/madhumb/ios-certificates.git
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.IOS_CERT_PAT_BASE64 }}
          APP_STORE_CONNECT_API_KEY_PATH: ${{ github.workspace }}/ios/fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8
          APPSTORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
          APPSTORE_CONNECT_ISSUER_ID: ${{ secrets.APPSTORE_CONNECT_ISSUER_ID }}
          KEYCHAIN_PASSWORD: "ci_keychain_pass"
        run: |
          ls -l fastlane
          cat fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8 | head -5
          LANE="${{ github.event.inputs.lane || 'beta' }}"
          FLAVOR="${{ matrix.flavor }}"
          echo "üöÄ Running Fastlane: ${LANE}_${FLAVOR}"
          

          git config --global url."https://${{ secrets.IOS_CERT_PAT }}@github.com/".insteadOf "https://github.com/"

          bundle exec fastlane "${LANE}_${FLAVOR}" \
            keychain_name:"build.keychain" \
            keychain_password:"ci_keychain_pass"

      # üì§ Upload IPA artifact
      - name: üì§ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.flavor }}-ipa
          path: ios/build/ios/**/*.ipa
