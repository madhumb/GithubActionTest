name: üöÄ iOS Flavored Upload

on:
  # push:
  #   branches: [ main ]

  workflow_dispatch:
    inputs:
      mode:
        description: "Choose build mode: all flavors or single flavor"
        required: true
        default: "single"
        type: choice
        options:
          - all
          - single
      flavor:
        description: "If single mode, specify flavor (e.g. star)"
        required: false
        default: "moon"
      lane:
        description: "Choose Fastlane lane (beta for TestFlight / release for App Store)"
        required: true
        default: "betaFlavour"

jobs:
 build:
  name: Build & Upload
  runs-on: macos-latest
  env:
    ASC_JSON_KEY: ${{ secrets.ASC_JSON_KEY }}
    FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
    FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}


  strategy:
    fail-fast: false
    matrix:
      flavor: ${{ fromJson(
        github.event_name == 'push' && '["moon","star"]' ||
        github.event.inputs.mode == 'all' && '["moon","star"]' ||
        format('["{0}"]', github.event.inputs.flavor || 'moon')) }}

  steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4


      # üíô Setup Flutter
      - name: üíô Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: 'stable'
          cache: true
        id: flutter

      - name: üì¶ Get Flutter dependencies
        run: |
          flutter clean
          flutter pub get

      # üîê Setup Keychain
      - name: Setup Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3.4"
          bundler-cache: true
          working-directory: ios


      - name: Setup app store connect
        run: |
          echo "$ASC_JSON_KEY" >> ./ios/fastlane/store.json
          echo "‚úÖ Created ios/fastlane/store.json"

      # - name: Verify App Store Connect key file
      #   run: |
      #     echo "Checking file existence and size..."
      #     ls -lh ios/fastlane/store.json
  
      #     echo "Validating JSON structure (safe partial print)..."
      #     head -n 5 ios/fastlane/store.json || true
  
      # üîë Create App Store API key file
    
      - name: üì¶ Install iOS Pods
        run: |
          cd ios
          pod install


      - name: Clean DerivedData
        run: rm -rf ~/Library/Developer/Xcode/DerivedData
       
      - name: Install signing certificates and provisioning profiles
        run: |
          bundle exec fastlane match appstore --readonly --verbose
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          # MATCH_KEYCHAIN_NAME: "login.keychain"
          # MATCH_KEYCHAIN_PASSWORD: "ci_keychain_password"
            

      # üèóÔ∏è Build & Upload flavor
      - name: üèóÔ∏è Build & Upload (${{ matrix.flavor }})
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
        run: |
          xcode-select -p

          LANE="${{ github.event.inputs.lane || 'beta' }}"
          FLAVOR="${{ matrix.flavor }}"
          echo "üöÄ Running Fastlane: ${LANE}_${FLAVOR}"
          
          bundle exec fastlane betaFlavour flavor:${{ matrix.flavor }}

            

      # üì§ Upload IPA artifact
      - name: üì§ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.flavor }}-ipa
          path: ios/build/ios/**/*.ipa

      - name: Print last 100 lines of Fastlane log if build fails
        if: failure()
        run: |
          filename="/Users/runner/Library/Logs/gym/Runner-${FLAVOR}.log"
          echo "=== Printing last 100 lines of ${filename} ==="
          if [ -f "${filename}" ]; then
            tail -n 100 "${filename}"
            tail -n 50 ~/Library/Logs/gym/Runner-moon.log

            tail -n 50 ~/Library/Logs/gym/Runner-star.log

          else
            echo "Log file not found: ${filename}"
          fi
        env:
          FLAVOR: ${{ matrix.flavor }}
        
        