name: üöÄ iOS App Upload (Flavored)

on:
  workflow_dispatch:
    inputs:
      flavor:
        description: "Which flavor to build (e.g. ahbenefits, pecoconnect, etc)"
        required: true
        default: "star"
      lane:
        description: "Choose Fastlane lane (beta for TestFlight / release for App Store)"
        required: true
        default: "beta"

jobs:
  build-and-upload:
    name: Build & Upload ${{ github.event.inputs.flavor }} (${{ github.event.inputs.lane }})
    runs-on: macos-latest

    steps:
      ##############################################################
      # üß± Checkout Repository
      ##############################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ##############################################################
      # üê¶ Setup Flutter
      ##############################################################
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: Flutter pub get
        run: flutter pub get

      ##############################################################
      # üíé Setup Ruby & Fastlane
      ##############################################################
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.4

      - name: Install Fastlane
        run: gem install fastlane

      ##############################################################
      # üîê Setup App Store Connect API Key
      ##############################################################
      - name: Decode API key file
        run: |
          mkdir -p ios/fastlane
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_JSON }}" > ios/fastlane/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
        shell: bash

      ##############################################################
      # üçè Build & Upload with Fastlane
      ##############################################################
      - name: Run Fastlane for selected flavor
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_CONNECT_API_KEY: ios/fastlane/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          bundle exec fastlane ${{ github.event.inputs.lane }}_${{ github.event.inputs.flavor }}

      ##############################################################
      # üßæ Optional: Upload logs or artifacts
      ##############################################################
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.flavor }}-ipa
          path: ios/build/ios/${{ github.event.inputs.flavor }}.ipa
