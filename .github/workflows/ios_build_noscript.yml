name: ğŸš€ iOS Flavored Upload

on:
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      mode:
        description: "Choose build mode: all flavors or single flavor"
        required: true
        default: "single"
        type: choice
        options:
          - all
          - single
      flavor:
        description: "If single mode, specify flavor (e.g. star)"
        required: false
        default: "moon"
      lane:
        description: "Choose Fastlane lane (beta for TestFlight / release for App Store)"
        required: true
        default: "betaFlavour"

jobs:
 build:
  name: Build & Upload
  runs-on: macos-latest
  env:
    ASC_JSON_KEY: ${{ secrets.ASC_JSON_KEY }}
    FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
    FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}


  strategy:
    fail-fast: false
    matrix:
      flavor: ${{ fromJson(
        github.event_name == 'push' && '["moon","star"]' ||
        github.event.inputs.mode == 'all' && '["moon","star"]' ||
        format('["{0}"]', github.event.inputs.flavor || 'moon')) }}

  steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4


      # ğŸ’™ Setup Flutter
      - name: ğŸ’™ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"
          channel: 'stable'
          cache: true
        id: flutter

      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get

      # ğŸ” Setup Keychain
      - name: Setup Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3.4"
          bundler-cache: true
          working-directory: ios


      - name: Setup app store connect
        run: echo "$ASC_JSON_KEY" >> ./ios/fastlane/store.json
  
      # ğŸ”‘ Create App Store API key file
    
      - name: ğŸ“¦ Install iOS Pods
        run: |
          cd ios
          pod install


      - name: Clean DerivedData
        run: rm -rf ~/Library/Developer/Xcode/DerivedData
               

      # ğŸ—ï¸ Build & Upload flavor
      - name: ğŸ—ï¸ Build & Upload (${{ matrix.flavor }})
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
        run: |
          xcode-select -p

          LANE="${{ github.event.inputs.lane || 'beta' }}"
          FLAVOR="${{ matrix.flavor }}"
          echo "ğŸš€ Running Fastlane: ${LANE}_${FLAVOR}"
          
          bundle exec fastlane betaFlavour flavor:${{ matrix.flavor }}

            

      # ğŸ“¤ Upload IPA artifact
      - name: ğŸ“¤ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.flavor }}-ipa
          path: ios/build/ios/**/*.ipa

      - name: Print xcodebuild log if Fastlane fails
        if: failure()
        run: |
          ls /Users/runner/Library/Logs/gym/ || true
          FLAVOR="${{ matrix.flavor }}"
          cat /Users/runner/Library/Logs/gym/Runner-${FLAVOR}.log  || true
       
