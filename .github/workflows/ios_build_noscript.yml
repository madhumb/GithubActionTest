name: ğŸš€ iOS Flavored Upload

on:
  push:
    branches:
        - main  
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose build mode: all flavors or single flavor"
        required: true
        default: "single"
        type: choice
        options:
          - all
          - single
      flavor:
        description: "If single mode, specify flavor (e.g. star)"
        required: false
        default: "star"
      lane:
        description: "Choose Fastlane lane (beta for TestFlight / release for App Store)"
        required: true
        default: "beta"
       

jobs:
  ##############################################################
  # ğŸ§© Option 1: Build ALL flavors (parallel matrix)
  ##############################################################
  all-flavors:
    if: ${{ github.event.inputs.mode == 'all' || github.event_name == 'push'}}
    name: Build & Upload (All Flavors)
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        flavor: [ "star", "moon" ] # ğŸ” Add your other flavors here

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      # ğŸ’ Setup Ruby with Bundler caching
      - name: ğŸª„ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.4
          bundler-cache: true
          working-directory: ios

      # ğŸ’™ Setup Flutter
      - name: ğŸ’™ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get

      - name: ğŸ”‘ Create API key file
        run: |
          mkdir -p ios/fastlane
          echo "Creating API key file...${APPSTORE_CONNECT_API_KEY_ID}"
          printf "%s" "${APP_STORE_CONNECT_API_KEY}" > ios/fastlane/AuthKey_${APPSTORE_CONNECT_API_KEY_ID}.p8
          ls -l ios/fastlane/
        env:
          APPSTORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
    

      # ğŸ—ï¸ Build & Upload current flavor
      - name: ğŸ—ï¸ Build and Upload ${{ matrix.flavor }}
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_PATH: fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8
          APPSTORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
          APPSTORE_CONNECT_ISSUER_ID: ${{ secrets.APPSTORE_CONNECT_ISSUER_ID }}
        run: |
          LANE="${{ github.event.inputs.lane || 'beta' }}"
          echo "ğŸš€ Running lane: ${LANE}_${{ matrix.flavor }}"
          echo "ğŸ” Checking for API key at: fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8"
          ls -l fastlane || true
          file fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8 || true
          bundle exec fastlane "${LANE}_${{ matrix.flavor }}"
         

      # ğŸ“¤ Upload built IPA
      - name: ğŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.flavor }}-ipa
          path: ios/build/ios/**/*.ipa

  ##############################################################
  # ğŸ§© Option 2: Build a SINGLE selected flavor
  ##############################################################
  single-flavor:
    if: ${{ github.event.inputs.mode == 'single' }}
    name: Build & Upload (${{ github.event.inputs.flavor }})
    runs-on: macos-latest
    env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APP_STORE_CONNECT_API_KEY_PATH: ios/fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8
        APPSTORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
        APPSTORE_CONNECT_ISSUER_ID: ${{ secrets.APPSTORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }} 


    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      # ğŸ’ Setup Ruby with Bundler caching
      - name: ğŸª„ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.4
          bundler-cache: true
          working-directory: ios

      # ğŸ’™ Setup Flutter
      - name: ğŸ’™ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get

      # ğŸ”‘ Prepare App Store API key
      - name: Create API key file
        run: |
            mkdir -p ios/fastlane
            echo "Creating API key file...${APPSTORE_CONNECT_API_KEY_ID}"
            printf "%s" "${APP_STORE_CONNECT_API_KEY}" > ios/fastlane/AuthKey_${APPSTORE_CONNECT_API_KEY_ID}.p8
            
            echo "File created:"
            ls -l ios/fastlane/
            echo "File preview (first 3 lines):"
            head -n 3 ios/fastlane/AuthKey_${APPSTORE_CONNECT_API_KEY_ID}.p8
        env:
            APPSTORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
            APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }} 
                
      - name: Set API key path env
        run: echo "APP_STORE_CONNECT_API_KEY_PATH=ios/fastlane/AuthKey_${APPSTORE_CONNECT_API_KEY_ID}.p8" >> $GITHUB_ENV

            
      # ğŸ—ï¸ Build & Upload the selected flavor
      - name: ğŸ—ï¸ Build and Upload selected flavor
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_PATH: ios/fastlane/AuthKey_${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}.p8
          APPSTORE_CONNECT_API_KEY_ID: ${{ secrets.APPSTORE_CONNECT_API_KEY_ID }}
          APPSTORE_CONNECT_ISSUER_ID: ${{ secrets.APPSTORE_CONNECT_ISSUER_ID }}
        run: |
          echo "ğŸš€ Running lane: ${{ github.event.inputs.lane }}_${{ github.event.inputs.flavor }}"
          bundle exec fastlane ${{ github.event.inputs.lane }}_${{ github.event.inputs.flavor }}

      # ğŸ“¤ Upload built IPA
      - name: ğŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.flavor }}-ipa
          path: ios/build/ios/**/*.ipa
