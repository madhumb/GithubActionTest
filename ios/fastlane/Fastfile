# # This file contains the fastlane.tools configuration
# # You can find the documentation at https://docs.fastlane.tools
# #
# # For a list of all available actions, check out
# #
# #     https://docs.fastlane.tools/actions
# #
# # For a list of all available plugins, check out
# #
# #     https://docs.fastlane.tools/plugins/available-plugins
# #

# # Uncomment the line if you want fastlane to automatically update itself
# # update_fastlane

# default_platform(:ios)

# platform :ios do
  
#   lane :beta do |options|
#     scheme = options[:scheme] || "Runner"
#     build_app(
#       scheme: scheme,
#       output_directory: "./build",
#       output_name: "#{scheme}.ipa",
#       export_method: "app-store", # Still use 'app-store' for TestFlight uploads
#       export_options: {
#         provisioningProfiles: {
#           "com.recode.bookmark" => "Bookmark Apprstore profile",
#           "com.gnkbros.app" =>"com.gnkbros.app appstore"
#         }
#       }
#     )
  
#     # Upload dSYMs to Firebase Crashlytics
#     plist_path = "./config/#{scheme}/GoogleService-Info.plist"
#     dsyms_path = "./build/#{scheme}.app.dSYM.zip"
  
#     upload_symbols_to_crashlytics(
#       gsp_path: plist_path,
#       dsym_path: dsyms_path
#     )
  
#     # Upload to TestFlight
#     ipa_path = "./build/#{scheme}.ipa"
  
#     upload_to_testflight(
#       ipa: ipa_path,
#       skip_waiting_for_build_processing: false,
#       distribute_external: false, # change to true if you want to invite external testers
#       api_key: app_store_connect_api_key(
#         key_id: "4M2F6PDL8N",
#         issuer_id: "69a6de85-d828-47e3-e053-5b8c7c11a4d1",
#         key_filepath: "/Users/madhubhilawadi/private_keys/AuthKey.p8",
#         in_house: false
#       )
#     )
#   end

  

#   desc "Push a new release build to the App Store"
#   lane :release do |options|
#     scheme = options[:scheme] || "Runner"
#     match(
#       type: "appstore",
#       app_identifier: ["com.gnkbros.app"],  # <-- replace with yours
#       username: "madhu@strivebenefits.com",
#       git_url: ENV["MATCH_GIT_URL"],
#     )

#     build_app(
#       scheme: scheme,
#       output_directory: "./build",
#       output_name: "#{scheme}.ipa",
#       export_method: "app-store",
#       export_options: {
#       provisioningProfiles: {
#         "com.recode.bookmark" => "Bookmark Apprstore profile",
#         "com.gnkbros.app" =>"com.gnkbros.app appstore"

#       }
#     }
#     )

#     plist_path = "./config/#{scheme}/GoogleService-Info.plist"

#     # Path to the dSYMs directory (Fastlane finds them automatically if built)
#     dsyms_path = "./build/#{scheme}.app.dSYM.zip"

#     # Upload to Firebase Crashlytics
#     upload_symbols_to_crashlytics(
#       gsp_path: plist_path,
#       dsym_path: dsyms_path
#     )
    
#     ipa_path = "./build/#{scheme}.ipa",

#     upload_to_app_store(
#       ipa: ipa_path,
#       skip_metadata: true,
#       precheck_include_in_app_purchases: false,
#       skip_screenshots: true,
#       api_key: app_store_connect_api_key(
#         key_id: "4M2F6PDL8N",
#         issuer_id: "69a6de85-d828-47e3-e053-5b8c7c11a4d1",
#         key_filepath: "/Users/madhubhilawadi/private_keys/AuthKey.p8",
#         in_house: false
#       )
#     )
#   end
# end


default_platform(:ios)

platform :ios do
  ##############################################################
  # üîê Shared Config
  ##############################################################
  before_all do
    ENV["MATCH_PASSWORD"] = ENV["MATCH_PASSWORD"] || "Harder@123Git"

    UI.message("=== üîç Debugging App Store Connect ENV ===")
    UI.message("APP_STORE_CONNECT_API_KEY_PATH: #{ENV['APP_STORE_CONNECT_API_KEY']}")
    UI.message("APPSTORE_CONNECT_API_KEY_ID: #{ENV['APPSTORE_CONNECT_API_KEY_ID']}")
    UI.message("APP_STORE_CONNECT_ISSUER_ID: #{ENV['APPSTORE_CONNECT_ISSUER_ID']}")
    UI.message("Current working dir: #{Dir.pwd}")
    sh("ls -l ios/fastlane || true")
    UI.message("=========================================")

    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"] || "AuthKey_#{ENV['APPSTORE_CONNECT_API_KEY_ID']}.p8"
    unless File.exist?(api_key_path)
      UI.user_error!("‚ùå API key file not found at path: #{api_key_path}")
    end
    # API key for App Store Connect (recommended)
    if ENV["APP_STORE_CONNECT_API_KEY"]
      api_key = app_store_connect_api_key(
        key_id: ENV["APPSTORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APPSTORE_CONNECT_ISSUER_ID"],
        key_filepath: File.expand_path(ENV["APP_STORE_CONNECT_API_KEY_PATH"]),
        in_house: false
      )
      puts "üîç Using API key file: #{ENV['APP_STORE_CONNECT_API_KEY_PATH']}"
      sh("ls -l #{ENV['APP_STORE_CONNECT_API_KEY_PATH']} || true")
      
      ENV["APP_STORE_CONNECT_API_KEY"] = api_key
    end
  end

  ##############################################################
  # üß± Helper Method ‚Äî Builds a Flavor
  ##############################################################
  def build_flavor(flavor, bundle_id)
    UI.message("=== üîç Debugging App Store Connect ENV ===")
    UI.message("APP_STORE_CONNECT_API_KEY_PATH: #{ENV['APP_STORE_CONNECT_API_KEY_PATH']}")
    UI.message("APPSTORE_CONNECT_API_KEY_ID: #{ENV['APPSTORE_CONNECT_API_KEY_ID']}")
    UI.message("APPSTORE_CONNECT_ISSUER_ID: #{ENV['APPSTORE_CONNECT_ISSUER_ID']}")
    UI.message("Current working dir: #{Dir.pwd}")
  
    
    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"] || "AuthKey_#{ENV['APPSTORE_CONNECT_API_KEY_ID']}.p8"

    puts "üîç Using API key path: #{api_key_path}"
  
    api_key_full_path = File.absolute_path(api_key_path)
    UI.message("üîç Resolved API key absolute path: #{api_key_full_path}")
    
    if !File.exist?(api_key_full_path)
      UI.user_error!("‚ùå API key still not found at #{api_key_full_path}")
    end
    api_key = app_store_connect_api_key(
      key_id: ENV['APPSTORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APPSTORE_CONNECT_ISSUER_ID'],
      key_filepath: api_key_full_path
    )
        puts "üîç api_key: #{api_key.inspect}"


        require 'json'
        json_key_path = File.join(Dir.tmpdir, "fastlane_api_key.json")
        File.write(json_key_path, {
          key_id: ENV['APPSTORE_CONNECT_API_KEY_ID'],
          issuer_id: ENV['APPSTORE_CONNECT_ISSUER_ID'],
          key: File.read(File.expand_path(api_key_path))
        }.to_json)

        UI.message("‚úÖ Created API key JSON for match: #{json_key_path}")

        match(
          type: "appstore",
          app_identifier: bundle_id,
          api_key_path: json_key_path
        )

    # match(type: "appstore", app_identifier: bundle_id,api_key: api_key)

    gym(
      workspace: "Runner.xcworkspace",
      scheme: flavor,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build/ios",
      output_name: "#{flavor}.ipa",
      clean: true
    )
  end

  ##############################################################
  # üß™ Helper ‚Äî Upload to TestFlight
  ##############################################################
  def upload_testflight(flavor, bundle_id)
    pilot(
      ipa: "./build/ios/#{flavor}.ipa",
      app_identifier: bundle_id,
      skip_waiting_for_build_processing: true,
      api_key: api_key
    )
  end

  ##############################################################
  # üö¢ Helper ‚Äî Upload to App Store (for manual release)
  ##############################################################
  def upload_appstore(flavor, bundle_id)
    deliver(
      ipa: "./build/ios/#{flavor}.ipa",
      app_identifier: bundle_id,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      api_key: api_key
    )
  end

  ##############################################################
  # ‚ú® Define your flavors here
  ##############################################################
  flavors = {
    "moon" => "com.recode.bookmark",
    "star" => "com.gnkbros.app",
    
  }

  ##############################################################
  # üß© Dynamically Create Lanes for Each Flavor
  ##############################################################
  flavors.each do |flavor, bundle_id|
    desc "Build #{flavor} and upload to TestFlight"
    lane :"beta_#{flavor}" do
      build_flavor(flavor, bundle_id)
      upload_testflight(flavor, bundle_id)
    end

    desc "Build #{flavor} and upload to App Store (manual release)"
    lane :"release_#{flavor}" do
      build_flavor(flavor, bundle_id)
      upload_appstore(flavor, bundle_id)
    end
  end

  ##############################################################
  # üßπ Cleanup
  ##############################################################
  after_all do |lane|
    puts "‚úÖ Finished lane: #{lane}"
  end

  error do |lane, exception|
    puts "‚ùå Lane failed: #{lane}"
    puts exception.message
  end
end
