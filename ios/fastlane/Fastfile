# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane
default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    setup_ci if ENV['CI']
    match(app_identifier: "com.gnkbros.app", type: "appstore",readonly:true, git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"])
    build_app(workspace: "Runner.xcworkspace", scheme: "Release", export_method: "app-store")
    pilot(api_key_path: "fastlane/store.json", skip_waiting_for_build_processing: true)
  end
  
end

# Define all flavor configurations in a single object (Hash)
FLAVOR_CONFIGS = {
  "star" => {
    name: "star",
    bundle_id: "com.gnkbros.app",
    configuration: "starRelease",
    main: "lib/main_star.dart"
  },
  "moon" => {
    name: "moon",
    bundle_id: "com.recode.bookmark",
    configuration: "moonRelease",
    main: "lib/main_moon.dart"
  },
 
}.freeze


platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :betaFlavour do |options|
    flavor = options[:flavor]
    config = FLAVOR_CONFIGS[flavor]
    congigname = config[:configuration] || "Release"
  
    setup_ci if ENV['CI']
    match(app_identifier: config[:bundle_id], type: "appstore",readonly: ENV['CI'] ? true : false, git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"])
    build_app(workspace: "Runner.xcworkspace", scheme: config[:name], export_method: "app-store", configuration: "#{congigname}",
    export_options: {
      provisioningProfiles: {
        "com.gnkbros.app" => "match AppStore com.gnkbros.app",
        "com.recode.bookmark" => "match AppStore com.recode.bookmark",
      }
    })
    pilot(api_key_path: "fastlane/store.json", skip_waiting_for_build_processing: true)
  end
  
end