# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane
default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    setup_ci if ENV['CI']
    match(app_identifier: "com.gnkbros.app", type: "appstore",readonly:true, git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"])
    build_app(workspace: "Runner.xcworkspace", scheme: "Release", export_method: "app-store")
    pilot(api_key_path: "fastlane/store.json", skip_waiting_for_build_processing: true)
  end
  
end

# Define all flavor configurations in a single object (Hash)
FLAVOR_CONFIGS = {
  "star" => {
    name: "star",
    bundle_id: "com.gnkbros.app",
    configuration: "starRelease",
    main: "lib/main_star.dart",
    provisioning_profile: "match AppStore com.gnkbros.app"
  },
  "moon" => {
    name: "moon",
    bundle_id: "com.recode.bookmark",
    configuration: "moonRelease",
    main: "lib/main_moon.dart",
    provisioning_profile: "match AppStore com.recode.bookmark"
  },
 
}.freeze


platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :betaFlavour do |options|
    flavor = options[:flavor]
    config = FLAVOR_CONFIGS[flavor]
    config_name = config[:configuration] || "Release"
  
    setup_ci if ENV['CI']
    sh("ls -lh ./fastlane/store.json")
    api_key = app_store_connect_api_key(
      key_content: File.read("./fastlane/store.json")
    )
    
    match(app_identifier: config[:bundle_id], type: "appstore",readonly: ENV['CI'] ? true : false, git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],api_key: api_key,)
    xcode_select("/Applications/Xcode_16.4.app")

    sh("rm -rf ~/Library/Developer/Xcode/DerivedData || true")
    sh("rm -rf ~/Library/MobileDevice/Provisioning\\ Profiles/* || true")

    build_app(workspace: "Runner.xcworkspace", scheme: config[:name], export_method: "app-store", configuration:config_name,
    xcargs: "-allowProvisioningUpdates",
    # export_options: {
    #   provisioningProfiles: {
    #     config[:bundle_id] => config[:provisioning_profile]
    #   }
    # }
    )
    pilot(api_key: api_key,
      # api_key_path: "fastlane/store.json", 
      skip_waiting_for_build_processing: true)
  end
  
end